# SA20: 종목분석

## 📋 명령어 정보

- **코드명**: SA20
- **명령어**: 종목분석
- **설명**: 특정 종목에 대한 뉴스 분석 및 기술적 분석

---

## ⚙️ 실행 모드

**자동 실행 모드**: ON
- **중요: 사용자에게 절대 중간에 질문하지 않음**
- **중요: 모든 단계를 중단 없이 연속으로 자동 실행**
- 사용자 확인 없이 모든 절차 자동 실행
- 중간 질문 없음
- 에러 발생 시에만 사용자에게 알림
- 완료 후 최종 결과만 요약해서 출력

**자동 Git 커밋**: ON
- 모든 분석 완료 후 자동으로 git add & commit 실행
- 사용자 확인 없이 자동 커밋

---

## 📝 실행 절차

### 1. **입력 파라미터 확인**
   - 종목명 또는 종목코드 확인
   - 예: "SA20 고영" 또는 "SA20 098460"
   - 종목명인 경우 종목코드로 변환 (pykrx 사용)

### 2. **날짜 확인**
   - 분석 날짜: 오늘 날짜 (YYYY-MM-DD 형식)
   - 뉴스 검색 기간: 오늘부터 2주 전까지 (14일)

### 3. **뉴스 수집 (네이버 뉴스 검색 크롤링)**
   - URL: `https://search.naver.com/search.naver?where=news&query={종목명}+{종목코드}`
   - 크롤링 방법:
     1. 네이버 뉴스 검색 페이지 접근 (최신순 정렬)
     2. 최근 2주 이내 뉴스 목록 추출
     3. 각 뉴스별 정보 수집:
        - 뉴스 제목
        - 뉴스 날짜 (상대 시간: "N시간 전", "N일 전" 또는 "YYYY.MM.DD")
        - 뉴스 링크
        - 본문 미리보기
        - 언론사
     4. 날짜 필터링: 2주(14일) 이내 뉴스만 선택
     5. 최대 3페이지(30개) 수집

   **크롤링 상세:**
   ```python
   import requests
   from bs4 import BeautifulSoup
   from datetime import datetime, timedelta
   import time
   import re

   stock_name = "고영"
   stock_code = "098460"

   base_url = "https://search.naver.com/search.naver"
   headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}

   articles = []

   for page in range(1, 4):  # 최대 3페이지
       params = {
           'where': 'news',
           'query': f'{stock_name} {stock_code}',
           'start': (page - 1) * 10 + 1,
           'sort': '1'  # 최신순
       }

       response = requests.get(base_url, params=params, headers=headers, timeout=10)
       soup = BeautifulSoup(response.text, 'html.parser')

       # 뉴스 항목 찾기 (네이버 뉴스 검색 결과 CSS 클래스)
       news_items = soup.select('.o2YzmBxKhEuKOM4uNxFM')

       if not news_items:
           break

       for item in news_items:
           # 제목과 링크 추출
           title_link = item.select_one('a[data-heatmap-target=".tit"]')
           if not title_link:
               continue

           link = title_link.get('href', '')
           title_span = title_link.select_one('span')
           if title_span:
               # mark 태그 제거
               for mark in title_span.find_all('mark'):
                   mark.unwrap()
               title = title_span.get_text(strip=True)
           else:
               title = title_link.get_text(strip=True)

           # 언론사 추출
           press_link = item.select_one('a[data-heatmap-target=".prof"]')
           press = press_link.get_text(strip=True) if press_link else '출처 미상'

           # 본문 미리보기 추출
           body_link = item.select_one('a[data-heatmap-target=".body"]')
           if body_link:
               body_span = body_link.select_one('span')
               if body_span:
                   for mark in body_span.find_all('mark'):
                       mark.unwrap()
                   content = body_span.get_text(strip=True)
               else:
                   content = body_link.get_text(strip=True)
           else:
               content = ''

           # 날짜 추출
           date_elem = item.find('span', {'data-sds-comp': 'TimeLapse'})
           if date_elem:
               date_text = date_elem.get_text(strip=True)
           else:
               # 텍스트에서 날짜 패턴 찾기
               all_text = item.get_text()
               date_patterns = [r'\d+시간 전', r'\d+일 전', r'\d+분 전', r'\d{4}\.\d{2}\.\d{2}\.']
               for pattern in date_patterns:
                   match = re.search(pattern, all_text)
                   if match:
                       date_text = match.group().rstrip('.')
                       break

           # 날짜 파싱 및 필터링 (parse_date 함수 사용)
           article_date = parse_date(date_text)
           if article_date and article_date < start_date:
               # 2주 이전 뉴스 발견 시 수집 중단
               break

           articles.append({
               'title': title,
               'link': link,
               'press': press,
               'date': date_text,
               'content': content
           })

       time.sleep(1)  # 서버 부하 방지

   # parse_date 함수: "N일 전", "N시간 전", "YYYY.MM.DD" -> datetime 변환
   def parse_date(date_text):
       now = datetime.now()
       if '분 전' in date_text:
           minutes = int(re.search(r'(\d+)', date_text).group(1))
           return now - timedelta(minutes=minutes)
       elif '시간 전' in date_text:
           hours = int(re.search(r'(\d+)', date_text).group(1))
           return now - timedelta(hours=hours)
       elif '일 전' in date_text:
           days = int(re.search(r'(\d+)', date_text).group(1))
           return now - timedelta(days=days)
       else:
           date_match = re.search(r'(\d{4})\.(\d{1,2})\.(\d{1,2})', date_text)
           if date_match:
               year, month, day = date_match.groups()
               return datetime(int(year), int(month), int(day))
       return None
   ```

   **오류 처리:**
   - 네트워크 오류 시: 다음 페이지로 진행하지 않고 중단
   - 뉴스가 없는 경우: "최근 2주 내 뉴스 없음"으로 표시
   - CSS 셀렉터 변경 시: `.o2YzmBxKhEuKOM4uNxFM` 클래스가 변경되면 code/analyze_news_ultimate.py의 `.vs1RfKE1eTzMZ5RqnhIv` 참고

### 4. **임시 뉴스 파일 생성**
   - 파일 경로: `report/analysis/{종목명}-{날짜}_raw.md`
   - 파일 내용:
     ```markdown
     # {종목명} 뉴스 수집 (Raw Data)

     분석 날짜: {날짜}
     종목코드: {종목코드}

     ---

     ## 주요 뉴스 목록

     ### [{날짜}] {뉴스 제목}
     - 출처: {언론사}
     - 링크: {URL}
     - 내용: {본문 요약}

     ---
     ```

### 5. **뉴스 분석 (AI 심층 분석)**
   - 수집된 뉴스를 읽고 다음 항목을 심층 분석:

   **A. 종목 정체성 파악**
   - 이 회사가 무엇을 하는 회사인가?
   - 주력 사업/제품/서비스는 무엇인가?
   - 어떤 산업군에 속하는가?
   - 예: "고영은 3D 검사장비 전문업체이며, 최근 의료로봇 사업 진출"

   **B. 최근 주가 상승/하락 원인 분석**
   - 뉴스에서 주가 변동의 직접적 원인 파악
   - 단순 키워드 매칭이 아닌, 뉴스 내용을 읽고 분석
   - 예시:
     * 실적: 3분기 영업이익 전년 대비 576% 증가 → 어닝 서프라이즈
     * 신제품: 의료로봇 'KYMERO' 미국 FDA 승인 → 신사업 모멘텀
     * 수주/계약: 특정 기업과 X억원 규모 계약 체결 → 매출 가시성
     * 학술/연구: 세계적 학술지 JNS 논문 게재 → 기술력 인정
     * 시장 환경: 반도체 업황 회복 → 업종 전체 상승

   **C. 호재 뉴스 정리**
   - 뉴스별로 구체적인 내용 요약
   - 각 호재가 주가에 미치는 영향도 평가 (상/중/하)
   - 표 형식:
     | 구분 | 내용 | 영향도 | 날짜 |
     |------|------|--------|------|
     | 실적 개선 | 3Q 영업이익 47억원 (YoY +576%) | 상 | 2일 전 |
     | 신제품 | 뇌수술 로봇 미국 FDA 승인, 수출 시작 | 상 | 8시간 전 |
     | 기술 인정 | 카이메로 논문 JNS 학술지 게재 | 중 | 21시간 전 |

   **D. 악재 뉴스 정리**
   - 뉴스별로 구체적인 내용 요약
   - 각 악재가 주가에 미치는 영향도 평가
   - 표 형식 동일

   **E. 종합 요약 (3-5문장)**
   - 이 종목의 정체성 한 문장
   - 최근 주가 움직임의 핵심 원인 1-2문장
   - 향후 주목해야 할 포인트 1-2문장
   - 예시: "고영은 3D 검사장비 전문기업으로 최근 의료로봇 사업에 진출했다. 3분기 실적이 예상을 크게 상회하고 뇌수술 로봇의 미국 수출이 시작되면서 주가가 급등했다. 향후 일본 시장 진출과 의료로봇 매출 확대가 주가의 핵심 변수다."

### 6. **기술적 분석 (pykrx 사용)**
   - 지난 3년(1095일) 주가 데이터 수집

   **데이터 수집:**
   ```python
   from pykrx import stock
   from datetime import datetime, timedelta

   end_date = datetime.now().strftime('%Y%m%d')
   start_date = (datetime.now() - timedelta(days=1095)).strftime('%Y%m%d')

   # OHLCV 데이터
   df = stock.get_market_ohlcv_by_date(start_date, end_date, stock_code)

   # 시가총액 데이터 (현재일 기준)
   today = datetime.now().strftime('%Y%m%d')
   cap_df = stock.get_market_cap_by_date(today, today, stock_code)
   market_cap = cap_df.iloc[0]['시가총액']  # 단위: 원
   market_cap_uk = int(market_cap / 100000000)  # 억원 단위 변환

   # 데이터 포함 항목:
   # - 시가, 고가, 저가, 종가
   # - 거래량
   # - 시가총액 (억원)
   ```

   **기술적 분석 항목:**

   **A. 가격 추세 분석**
   - 3년 평균 주가
   - 52주 최고가/최저가
   - 현재가 대비 52주 최고가 비율
   - 현재가 대비 52주 최저가 비율
   - **시가총액** (억원)

   **B. 이동평균선 분석**
   - 5일, 20일, 60일, 120일 이동평균선 계산
   - 골든크로스/데드크로스 확인
   - 현재가와 이동평균선 관계

   **C. 거래량 분석**
   - 3년 평균 거래량
   - 최근 1개월 평균 거래량
   - 거래량 증가/감소 추세

   **D. 변동성 분석**
   - 최근 3개월 변동성 (표준편차)
   - 고점 대비 현재가 위치
   - 저점 대비 현재가 위치

   **E. 지지선/저항선**
   - 최근 6개월 주요 지지선 (저점 3개)
   - 최근 6개월 주요 저항선 (고점 3개)

   **F. 최근 3개월 주가 차트 (텍스트)**
   - 최근 3개월(60거래일) 종가를 텍스트 차트로 시각화
   - 가로축: 날짜 (주 단위)
   - 세로축: 주가 (천원 단위)
   - 예시:
   ```
   최근 3개월 주가 추이 (단위: 천원)

   22 ┤                                                    ●
   21 ┤                                                  ● │
   20 ┤                                                ●   │●
   19 ┤                                              ●     │
   18 ┤                                            ●       │
   17 ┤                                    ●     ●         │
   16 ┤                          ●   ● ●   ● ●             │
   15 ┤                    ●   ●   ●                       │
   14 ┤        ●     ● ● ●                                 │
   13 ┤  ● ● ●   ● ●                                       │
   12 ┤●                                                    │
      └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
      8/7   8/14  8/21  8/28  9/4   9/11  9/18  9/25  10/2  10/9  10/16 10/23 10/30 11/6

   📊 주요 구간:
   - 8월 초: 12,000원대 (저점)
   - 9월: 14,000~16,000원 박스권
   - 10월 중순~말: 16,000원 돌파, 상승 추세
   - 11월 초: 20,000원 돌파 (급등)
   ```

   **구현 방법:**
   ```python
   import numpy as np

   # 최근 3개월 데이터
   df_3m = df.tail(60)
   prices = df_3m['종가'].values
   dates = df_3m.index

   # 차트 생성 (간단한 ASCII 차트)
   def create_text_chart(prices, dates, height=15, width=80):
       min_price = int(prices.min() / 1000) * 1000
       max_price = int(prices.max() / 1000) * 1000 + 1000

       # 정규화
       normalized = (prices - min_price) / (max_price - min_price) * (height - 1)

       # 차트 그리기
       chart_lines = []
       for i in range(height - 1, -1, -1):
           line = []
           price_label = int(min_price + (max_price - min_price) * i / (height - 1)) // 1000
           line.append(f"{price_label:2d} ┤")

           for j, val in enumerate(normalized):
               if abs(val - i) < 0.5:
                   line.append("●")
               elif val > i:
                   line.append("│")
               else:
                   line.append(" ")

           chart_lines.append(''.join(line))

       # x축
       x_axis = "   └" + "─" * len(normalized) + "┘"

       # 날짜 레이블 (주 단위)
       date_labels = "    "
       for i in range(0, len(dates), len(dates)//10):
           date_labels += dates[i].strftime('%m/%d') + "  "

       return '\n'.join(chart_lines) + '\n' + x_axis + '\n' + date_labels
   ```

### 7. **종합 판단**
   - 뉴스 재료와 기술적 분석을 종합하여 판단

   **A. 종목 이해도 요약**
   - 이 종목은 어떤 회사인가? (주력 사업 1-2줄)
   - 최근 주가 움직임의 핵심 원인은? (1-2줄)
   - 예: "고영은 3D 검사장비(반도체/디스플레이용) 제조업체로 최근 의료로봇 사업에 진출했다. 3분기 실적 호조와 뇌수술 로봇의 미국 FDA 승인/수출 개시가 주가 급등의 주요 원인이다."

   **B. 전체 평가**
   - 투자 매력도: 상/중/하
   - 리스크 수준: 상/중/하
   - 추천 투자 기간: 단기/중기/장기

   **C. 데이트레이딩 관점**
   - 데이트레이딩 적합도: 적합/보통/부적합
   - 이유 (구체적으로):
     * 변동성이 충분한가? (3개월 변동성 X%)
     * 거래량이 충분한가? (최근 1개월 평균 X백만주)
     * 단기 모멘텀이 있는가? (이동평균선 배열, 뉴스 모멘텀)
     * 뉴스 재료가 있는가? (무슨 뉴스로 상승했는가?)
   - 진입 가격대 제안 (지지선 기준)
   - 손절 가격대 제안 (지지선 이탈 시)
   - 목표 수익률 (변동성 기준)

   **D. 스윙투자 관점**
   - 스윙투자 적합도: 적합/보통/부적합
   - 이유 (구체적으로):
     * 중기 추세가 상승세인가? (60일선/120일선 관계)
     * 펀더멘털이 양호한가? (실적, 신사업, 수주 등)
     * 뉴스 모멘텀이 지속될 가능성은? (일회성 vs 지속성)
     * 업황/테마는? (업종 전체 상승 vs 개별 이슈)
   - 진입 가격대 제안 (지지선 + 추세 고려)
   - 손절 가격대 제안 (주요 지지선 이탈)
   - 목표 가격대 (저항선 또는 상승 여력)
   - 예상 보유 기간

   **E. 투자 시나리오**
   - 낙관 시나리오: "X 조건 충족 시 → 목표가 Y원"
   - 기본 시나리오: "현재 추세 유지 시 → 목표가 Z원"
   - 비관 시나리오: "X 리스크 발생 시 → 손절가 W원"

### 8. **최종 리포트 생성**
   - 파일 경로: `report/analysis/{종목명}-{날짜}.md`
   - 파일 구조:

   ```markdown
   # {종목명} ({종목코드}) 종목 분석

   **분석 일시**: YYYY-MM-DD HH:MM:SS
   **분석 기간**: 최근 2주 뉴스, 최근 3년 주가

   **📊 시가총액**: X,XXX억원
   **💰 현재가**: XX,XXX원

   ---

   ## 🏢 종목 개요

   ### 사업 내용
   - 주력 사업: [회사가 무엇을 하는지]
   - 주요 제품/서비스: [구체적인 제품명]
   - 산업 분류: [반도체, 바이오, IT 등]

   ### 최근 이슈
   - [최근 주가를 움직인 핵심 이벤트 2-3줄]

   ---

   ## 📰 뉴스 심층 분석

   ### 종합 요약
   [종목의 정체성과 최근 주가 움직임 원인을 3-5문장으로 정리]

   예: "고영은 3D 검사장비(반도체/디스플레이용) 제조 전문기업으로, 최근 의료로봇 사업에 진출했다. 3분기 영업이익이 전년 대비 576% 증가하며 시장 예상을 크게 상회했고, 뇌수술용 로봇 '카이메로'가 미국 FDA 승인을 받아 실제 수출이 시작됐다. 또한 해당 로봇 관련 논문이 세계적 권위의 신경외과 학술지 JNS에 게재되며 기술력을 인정받았다. 이러한 신사업 모멘텀과 실적 개선으로 최근 2주간 주가가 23% 급등했다."

   ### 주가 상승/하락 원인
   1. **실적 호조** (영향도: 상)
      - 3분기 영업이익 47억원 (전년 대비 +576%)
      - 매출 30% 증가로 어닝 서프라이즈

   2. **신사업 모멘텀** (영향도: 상)
      - 뇌수술 로봇 '카이메로' 미국 FDA 승인
      - 미국 납품 시작, 일본 진출 예정

   3. **기술력 인정** (영향도: 중)
      - JNS 학술지 논문 게재로 세계적 기술력 검증

   ### 호재 뉴스 상세
   | 구분 | 내용 | 영향도 | 날짜 |
   |------|------|--------|------|
   | 실적 개선 | 3Q 영업이익 47억원 (YoY +576%) | 상 | 2일 전 |
   | 신제품 | 뇌수술 로봇 미국 FDA 승인, 수출 시작 | 상 | 8시간 전 |
   | 기술 인정 | 카이메로 논문 JNS 학술지 게재 | 중 | 21시간 전 |

   ### 악재 뉴스 상세
   | 구분 | 내용 | 영향도 | 날짜 |
   |------|------|--------|------|
   | [없는 경우 "해당 없음"] | - | - | - |

   ---

   ## 📊 기술적 분석

   ### 가격 추세
   - 현재가: X,XXX원
   - 52주 최고가: X,XXX원 (현재가 대비 +XX%)
   - 52주 최저가: X,XXX원 (현재가 대비 -XX%)
   - 3년 평균가: X,XXX원

   ### 이동평균선
   - 5일선: X,XXX원
   - 20일선: X,XXX원
   - 60일선: X,XXX원
   - 120일선: X,XXX원
   - 정배열/역배열 여부

   ### 거래량 분석
   - 3년 평균 거래량: X,XXX,XXX주
   - 최근 1개월 평균: X,XXX,XXX주
   - 거래량 추세: 증가/감소/보합

   ### 변동성
   - 3개월 변동성: XX%

   ### 지지선/저항선
   - 지지선: X,XXX원, X,XXX원, X,XXX원
   - 저항선: X,XXX원, X,XXX원, X,XXX원

   ### 최근 3개월 주가 차트
   ```
   [텍스트 차트 삽입]
   ```

   **📊 주요 구간 분석**:
   - [기간별 주가 움직임 요약]

   ---

   ## 🎯 종합 판단

   ### 종목 이해
   **이 종목은?**
   - [회사 정체성 1-2줄]
   - 예: "고영은 3D 검사장비(반도체/디스플레이용) 제조 전문기업으로, 최근 의료로봇 사업에 진출했다."

   **최근 주가 움직임 원인**
   - [핵심 원인 1-2줄]
   - 예: "3분기 실적 호조(영업이익 +576%)와 뇌수술 로봇의 미국 FDA 승인/수출 개시가 주가 급등의 주요 원인이다."

   ### 전체 평가
   - **투자 매력도**: 상/중/하
   - **리스크 수준**: 상/중/하
   - **추천 기간**: 단기/중기/장기

   ### 💰 데이트레이딩 관점

   **적합도**: 적합/보통/부적합

   **분석**:
   - 변동성: 3개월 변동성 X%로 [충분/부족]
   - 거래량: 최근 1개월 평균 X백만주로 [충분/부족]
   - 단기 모멘텀: [5일선이 20일선 상회 등 구체적 분석]
   - 뉴스 재료: [무슨 뉴스로 상승했는지]

   **추천 전략**:
   - 진입 가격대: X,XXX원 ~ X,XXX원 (1차 지지선 기준)
   - 손절 가격: X,XXX원 (지지선 이탈 시)
   - 목표 수익률: X% (변동성 기준)

   ### 📈 스윙투자 관점

   **적합도**: 적합/보통/부적합

   **분석**:
   - 중기 추세: [60일선 위 거래, 정배열 등]
   - 펀더멘털: [실적 개선, 신사업 등 구체적 내용]
   - 모멘텀 지속성: [일회성 vs 지속성 판단 근거]
   - 업황/테마: [업종 상승 vs 개별 이슈]

   **추천 전략**:
   - 진입 가격대: X,XXX원 ~ X,XXX원 (추세 + 지지선)
   - 손절 가격: X,XXX원 (주요 지지선 이탈)
   - 목표 가격: X,XXX원 (저항선 또는 상승 여력)
   - 예상 보유 기간: X일 ~ X일

   ### 투자 시나리오
   - **낙관**: [X 조건 충족 시] → 목표가 Y원
   - **기본**: [현재 추세 유지] → 목표가 Z원
   - **비관**: [X 리스크 발생] → 손절가 W원

   ---

   ## 📑 주요 뉴스 상세

   ### [YYYY-MM-DD] {뉴스 제목}
   - 출처: {언론사}
   - 링크: {URL}
   - 내용: {본문 요약}

   ---

   *🤖 Generated with Claude Code*
   ```

### 9. **임시 파일 삭제**
   - `report/analysis/{종목명}-{날짜}_raw.md` 삭제

### 10. **자동 Git 커밋**
   - 생성된 리포트 파일 git add
   - 커밋 메시지: "feat: Add stock analysis for {종목명} ({날짜})"

---

## 📤 결과물

- `report/analysis/{종목명}-{날짜}.md` - 종목 분석 리포트

---

## 🔧 기술 스택

**라이브러리:**
- `pykrx`: 주가 데이터 수집
- `requests`, `beautifulsoup4`: 뉴스 크롤링
- `pandas`: 데이터 분석
- `numpy`: 기술적 지표 계산

**분석 지표:**
- 이동평균선 (Moving Average)
- 표준편차 (Standard Deviation)
- 지지선/저항선 (Support/Resistance)
- 거래량 추세 (Volume Trend)

---

*🤖 Generated with Claude Code*
